var Je=Object.defineProperty;var Ze=(e,t,n)=>t in e?Je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var He=(e,t,n)=>Ze(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const et=50,tt=2560,nt="rgba(17, 24, 39, 0.22)",it="#ffffff",st="rgba(255, 255, 255, 0.5)",Ie="#111827",de="bold 48px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",M=[];let p=null;function j(e){p=e;try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}}const c={hoveredAssetIndex:-1,selectedAssetIndices:new Set,isMovingSelected:!1,lastMoveClientX:0,lastMoveClientY:0,isMarqueeSelecting:!1,marqueeStartCX:0,marqueeStartCY:0,marqueeEndCX:0,marqueeEndCY:0,marqueeAdditive:!1,hoveredHandle:null,isResizingSelected:!1,activeHandle:null,resizeStartClientX:0,resizeStartClientY:0,initialSelectionBounds:null,initialSelectedSnapshot:null,historyPushedInGesture:!1,hoveringBackground:!1};function R(e){M.push(e);try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}}function ce(){const e=Array.from(c.selectedAssetIndices).sort((n,s)=>s-n);let t=0;for(const n of e)if(n>=0&&n<M.length){const s=M[n];try{if((s==null?void 0:s.type)!=="image"){if((s==null?void 0:s.type)==="video"){const i=s.element;try{if(i)try{i.pause()}catch{}}catch{}}}}catch{}M.splice(n,1),t+=1}c.selectedAssetIndices.clear(),c.hoveredAssetIndex=-1;try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}return t}function ot(){var s,i;const e=Array.from(c.selectedAssetIndices).sort((r,o)=>r-o),t=[];let n=0;for(const r of e){const o=M[r];if(!o)continue;const d=r+1+n;if(o.type==="image"){const a=o.sourceUrl||((s=o.element)==null?void 0:s.currentSrc)||((i=o.element)==null?void 0:i.src)||"",h=new Image;h.crossOrigin="anonymous",h.decoding="async",a&&(h.src=a);const f={type:"image",x:o.x+12,y:o.y+12,width:o.width,height:o.height,element:h,bitmap:null,loaded:!1,sourceUrl:a};h.addEventListener("load",()=>{f.loaded=!0;try{b()}catch{}}),M.splice(d,0,f)}else if(o.type==="video"){const a=document.createElement("video");a.crossOrigin="anonymous",a.playsInline=!0,a.muted=!0,a.loop=!0,a.preload="metadata",o.sourceUrl&&(a.src=o.sourceUrl);const h={type:"video",x:o.x+12,y:o.y+12,width:o.width,height:o.height,element:a,ready:!1,sourceUrl:o.sourceUrl};a.addEventListener("loadeddata",()=>{h.ready=!0;try{b()}catch{}}),M.splice(d,0,h)}else if(o.type==="text"){const a={type:"text",x:o.x+12,y:o.y+12,text:o.text,color:o.color,font:o.font,maxWidth:o.maxWidth};M.splice(d,0,a)}t.push(d),n+=1}c.selectedAssetIndices.clear();for(const r of t)c.selectedAssetIndices.add(r);try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}return t.length}function at(){const e=Array.from(c.selectedAssetIndices).sort((n,s)=>n-s),t=[];for(let n=e.length-1;n>=0;n-=1){const s=e[n],i=M.splice(s,1);i[0]&&t.unshift(i[0])}for(const n of t)M.push(n);c.selectedAssetIndices.clear();for(let n=M.length-t.length;n<M.length;n+=1)c.selectedAssetIndices.add(n);try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}}function rt(){const e=Array.from(c.selectedAssetIndices).sort((t,n)=>n-t);for(const t of e)if(t<M.length-1){const n=M.splice(t,1);n[0]&&(M.splice(t+1,0,n[0]),c.selectedAssetIndices.delete(t),c.selectedAssetIndices.add(t+1))}try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}}function dt(){const e=Array.from(c.selectedAssetIndices).sort((t,n)=>t-n);for(const t of e)if(t>0){const n=M.splice(t,1);n[0]&&(M.splice(t-1,0,n[0]),c.selectedAssetIndices.delete(t),c.selectedAssetIndices.add(t-1))}try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}}function ct(){const e=Array.from(c.selectedAssetIndices).sort((n,s)=>n-s),t=[];for(let n=0;n<e.length;n+=1){const s=e[n],i=M.splice(s-n,1);i[0]&&t.push(i[0])}M.splice(0,0,...t),c.selectedAssetIndices.clear();for(let n=0;n<t.length;n+=1)c.selectedAssetIndices.add(n);try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}}function lt(){var n;const e=Array.from(c.selectedAssetIndices)[0];if(e===void 0)return!1;const t=M[e];if(!t)return!1;if(p)try{const s=document.getElementById("main-canvas"),i=(n=s==null?void 0:s.getBoundingClientRect)==null?void 0:n.call(s),r=i?Math.round(i.width):800,o=i?Math.round(i.height):600,d=Math.round(r/2),a=Math.round(o/2);if(p.type==="image"){const h=p.element||p.bitmap||null,f=(h==null?void 0:h.naturalWidth)||(h==null?void 0:h.width)||400,u=(h==null?void 0:h.naturalHeight)||(h==null?void 0:h.height)||300,y=Math.max(40,Math.round(Math.min(r,o)*.4)),l=Math.max(f||1,u||1),w=Math.min(1,y/l),g=Math.max(40,Math.round((f||1)*w)),m=u&&f?u/f:9/16,x=Math.max(40,Math.round(g*m)),v=d-Math.round(g/2),E=a-Math.round(x/2);M.push({type:"image",x:v,y:E,width:g,height:x,element:p.element||null,bitmap:p.bitmap||null,loaded:!0,sourceUrl:""})}else if(p.type==="video"){const h=p.element;if(h){const f=h.videoWidth||480,u=h.videoHeight||270,y=Math.max(60,Math.round(Math.min(r*.6,520))),l=u&&f?u/f:9/16,w=Math.max(60,Math.round(y*l)),g=d-Math.round(y/2),m=a-Math.round(w/2);try{h.pause()}catch{}M.push({type:"video",x:g,y:m,width:y,height:w,element:h,ready:!0,sourceUrl:h.currentSrc||""})}}else if(p.type==="text"){const h=Math.max(120,Math.floor(r*.6));M.push({type:"text",x:d-Math.round(h/2),y:Math.round(o*.25),text:p.text||"",color:p.color,font:p.font,maxWidth:h})}}catch{}t.type==="image"?j({type:"image",element:t.element||null,bitmap:t.bitmap||null}):t.type==="video"?j({type:"video",element:t.element||null,ready:t.ready}):t.type==="text"&&j({type:"text",text:t.text,color:t.color,font:t.font}),M.splice(e,1),c.selectedAssetIndices.clear();try{document.dispatchEvent(new CustomEvent("assets:changed"))}catch{}return!0}function ht(e){return e?e.type==="image"?{type:"image",x:e.x,y:e.y,width:e.width,height:e.height,sourceUrl:e.sourceUrl||""}:e.type==="video"?{type:"video",x:e.x,y:e.y,width:e.width,height:e.height,sourceUrl:e.sourceUrl||""}:e.type==="text"?{type:"text",x:e.x,y:e.y,text:e.text,color:e.color,font:e.font,maxWidth:e.maxWidth}:null:null}function ut(e){return e?e.type==="image"?{type:"image",element:e.element||null,bitmap:e.bitmap||null}:e.type==="video"?{type:"video",element:e.element||null,ready:!!e.ready}:e.type==="text"?{type:"text",text:e.text||"",font:e.font,color:e.color}:null:null}function ft(){return{assets:M.map(ht),background:ut(p)}}const we=[];function k(){we.push(ft()),we.length>et&&we.shift()}let L,Y=null,N=null,Pe=null,$=null,qe="",le=!1,Ce=!1,O=null,ze=null,F=null,ue=!0,Ye=!0,ve=!1;const _e=10,mt=.75,gt=.65,ie=2,W=22,yt=33,Oe=new WeakMap;let Ue=0;function pt(){return M.some(e=>e.type==="video"&&e.element&&!e.element.paused&&!e.element.ended)||!!(p&&p.type==="video"&&p.element&&!p.element.paused&&!p.element.ended)}function wt(e,t,n){let s=Oe.get(e);const i=Math.max(1,Math.round(t)),r=Math.max(1,Math.round(n));if(!s){const o="OffscreenCanvas"in window?new window.OffscreenCanvas(i,r):document.createElement("canvas");"getContext"in o||(o.width=i,o.height=r);const d=o.getContext("2d",{alpha:!0});s={canvas:o,ctx:d},Oe.set(e,s)}return(s.canvas.width!==i||s.canvas.height!==r)&&(s.canvas.width=i,s.canvas.height=r),s}function vt(e){if(!e.__vfcAttached){e.__vfcAttached=!0;const t=s=>{const i=performance.now();if(i-Ue>=yt&&(Ue=i,b()),!e.paused&&!e.ended)try{e.requestVideoFrameCallback(t)}catch{requestAnimationFrame(()=>t(performance.now()))}},n=()=>{try{e.requestVideoFrameCallback(t)}catch{requestAnimationFrame(()=>t(performance.now()))}};e.addEventListener("play",n),e.addEventListener("ratechange",()=>{!e.paused&&!e.ended&&n()}),e.addEventListener("seeked",()=>{!e.paused&&!e.ended&&n()}),!e.paused&&!e.ended&&n()}}function Mt(e){le=e,ue=!0}function xt(e){Ye=e}function Ne(e){Ce=e,b()}function Ae(){return Ce}function bt(e){L=e,L.addEventListener("mousemove",t=>{const n=L.getBoundingClientRect(),s=Math.round(t.clientX-n.left),i=Math.round(t.clientY-n.top);c.hoveringBackground=s>=0&&i>=0&&s<=n.width&&i<=n.height;const r=K();let o=-1;for(let d=M.length-1;d>=0;d-=1){const a=U(r,M[d]);if(!(!a||a.w<=0||a.h<=0)&&s>=a.x&&i>=a.y&&s<=a.x+a.w&&i<=a.y+a.h){o=d;break}}if(o!==c.hoveredAssetIndex&&(c.hoveredAssetIndex=o,b()),c.isMovingSelected){if(!c.historyPushedInGesture){try{k()}catch{}c.historyPushedInGesture=!0}const d=s-c.lastMoveClientX,a=i-c.lastMoveClientY;c.lastMoveClientX=s,c.lastMoveClientY=i;for(const h of c.selectedAssetIndices){const f=M[h];f.x+=d,f.y+=a}L.style.cursor="grabbing",b();return}if(c.isResizingSelected){if(!c.historyPushedInGesture){try{k()}catch{}c.historyPushedInGesture=!0}const d=Array.from(c.selectedAssetIndices)[0];if(d!==void 0){const a=M[d],h=16,f=16,u=c.initialSelectionBounds||{x:a.x,y:a.y,w:a.width,h:a.height},y=s-(c.resizeStartClientX||s),l=i-(c.resizeStartClientY||i);let w=u.x,g=u.y,m=u.w,x=u.h;const v=c.activeHandle||"";if(a.type==="text"){if(v==="ml"||v==="mr"){const Ke=v==="ml"?-1:1,je=a.maxWidth||u.w||200,Qe=2*y*Ke*mt;let ee=je+Qe;ee=Math.round(ee/ie)*ie,ee=Math.max(120,Math.round(ee)),a.maxWidth=ee,b();return}u.w>0&&u.h>0&&u.w/u.h;const S=v==="tr"||v==="br"?1:-1,_=v==="bl"||v==="br"?1:-1,ge=(u.w+S*y)/u.w,Ge=(u.h+_*l)/u.h,Be=[ge,Ge].filter(pe=>isFinite(pe)&&pe>0);let D=Be.length?Math.min(...Be):1;D=1+(D-1)*gt;const ke=Math.max(h/u.w,f/u.h);D<ke&&(D=ke);let Q=(Te(a.font)||16)*D;Q=Math.round(Q/1)*1,Q=Math.max(8,Math.round(Q)),a.font=Tt(a.font,Q);let ye=(a.maxWidth?a.maxWidth:u.w)*D;ye=Math.round(ye/ie)*ie,a.maxWidth=Math.max(120,Math.round(ye));const Re=Math.round(u.w*D),We=Math.round(u.h*D);let J=u.x,Z=u.y;v==="br"&&(J=u.x,Z=u.y),v==="tr"&&(J=u.x,Z=u.y+(u.h-We)),v==="bl"&&(J=u.x+(u.w-Re),Z=u.y),v==="tl"&&(J=u.x+(u.w-Re),Z=u.y+(u.h-We)),a.x=Math.round(J),a.y=Math.round(Z),b();return}const E=u.w>0&&u.h>0?u.w/u.h:1,I=v==="tr"||v==="br"?1:-1,A=v==="bl"||v==="br"?1:-1,T=(u.w+I*y)/u.w,B=(u.h+A*l)/u.h,H=[T,B].filter(q=>isFinite(q)&&q>0);let P=H.length?Math.min(...H):1;const z=Math.max(h/u.w,f/u.h);P<z&&(P=z),m=Math.max(h,Math.round(u.w*P)),x=Math.max(f,Math.round(m/E)),v==="br"&&(w=u.x,g=u.y),v==="tr"&&(w=u.x,g=u.y+(u.h-x)),v==="bl"&&(w=u.x+(u.w-m),g=u.y),v==="tl"&&(w=u.x+(u.w-m),g=u.y+(u.h-x)),a.x=Math.round(w),a.y=Math.round(g),a.width=Math.round(m),a.height=Math.round(x),b()}return}if(c.isMarqueeSelecting){c.marqueeEndCX=s,c.marqueeEndCY=i;const d=Math.min(c.marqueeStartCX,c.marqueeEndCX),a=Math.min(c.marqueeStartCY,c.marqueeEndCY),h=Math.max(c.marqueeStartCX,c.marqueeEndCX),f=Math.max(c.marqueeStartCY,c.marqueeEndCY),u=K(),y=new Set(c.marqueeAdditive&&c.initialSelectedSnapshot?c.initialSelectedSnapshot:[]);for(let l=0;l<M.length;l+=1){const w=U(u,M[l]);if(!w||w.w<=0||w.h<=0)continue;const g=Math.max(d,w.x),m=Math.max(a,w.y),x=Math.min(h,w.x+w.w),v=Math.min(f,w.y+w.h);g<x&&m<v&&y.add(l)}c.selectedAssetIndices=y,c.hoveredAssetIndex=-1,b();return}if(L.style.cursor="default",c.hoveredHandle=null,c.selectedAssetIndices.size===1){const d=Array.from(c.selectedAssetIndices)[0],a=U(r,M[d]),h=ae(a);for(const[f,u]of Object.entries(h))if(s>=u.x&&i>=u.y&&s<=u.x+u.w&&i<=u.y+u.h){c.hoveredHandle=f,L.style.cursor=Pt(f);break}}c.hoveredHandle||(c.hoveredAssetIndex>=0?L.style.cursor="grab":L.style.cursor="default")},{passive:!0}),L.addEventListener("mousedown",t=>{const{x:n,y:s}=Lt(t),i=K();let r=-1;for(let o=M.length-1;o>=0;o-=1){const d=U(i,M[o]);if(!(!d||d.w<=0||d.h<=0)&&n>=d.x&&s>=d.y&&n<=d.x+d.w&&s<=d.y+d.h){r=o;break}}if(r>=0){const o=M[r];if(o.type==="video"&&o.element&&o.ready){const y=Math.round(o.x+o.width/2),l=Math.round(o.y+o.height/2),w=n-y,g=s-l;if(w*w+g*g<=(W+6)*(W+6)){try{o.element.paused||o.element.ended?o.element.play():o.element.pause()}catch{}b();return}}const d=!!(t.shiftKey||t.metaKey||t.ctrlKey||t.altKey);d||c.selectedAssetIndices.clear();const a=c.selectedAssetIndices.has(r);d&&(t.metaKey||t.ctrlKey||t.altKey)&&a?c.selectedAssetIndices.delete(r):c.selectedAssetIndices.add(r);const h=U(i,M[r]),f=ae(h);let u=!1;for(const[y,l]of Object.entries(f))if(n>=l.x&&s>=l.y&&n<=l.x+l.w&&s<=l.y+l.h){c.isResizingSelected=!0,c.activeHandle=y,c.initialSelectionBounds={...h},c.resizeStartClientX=n,c.resizeStartClientY=s,c.lastMoveClientX=n,c.lastMoveClientY=s,c.historyPushedInGesture=!1,u=!0;break}u||(c.isMovingSelected=!0,c.lastMoveClientX=n,c.lastMoveClientY=s,c.historyPushedInGesture=!1,L.style.cursor="grabbing"),b()}else{if(p&&p.type==="video"&&p.element&&p.ready){const o=L.getBoundingClientRect(),d=Math.round(o.width/2),a=Math.round(o.height/2),h=n-d,f=s-a;if(h*h+f*f<=(W+6)*(W+6)){try{p.element.paused||p.element.ended?p.element.play():p.element.pause()}catch{}b();return}}if(c.selectedAssetIndices.size===1){const o=Array.from(c.selectedAssetIndices)[0],d=U(i,M[o]),a=ae(d);for(const[h,f]of Object.entries(a))if(n>=f.x&&s>=f.y&&n<=f.x+f.w&&s<=f.y+f.h){c.isResizingSelected=!0,c.activeHandle=h,c.initialSelectionBounds={...d},c.resizeStartClientX=n,c.resizeStartClientY=s,c.lastMoveClientX=n,c.lastMoveClientY=s,c.historyPushedInGesture=!1,b();return}}c.isMarqueeSelecting=!0,c.marqueeStartCX=n,c.marqueeStartCY=s,c.marqueeEndCX=n,c.marqueeEndCY=s,c.marqueeAdditive=!!(t.shiftKey||t.metaKey||t.ctrlKey||t.altKey),c.initialSelectedSnapshot=new Set(c.selectedAssetIndices),b()}}),window.addEventListener("mouseup",()=>{if((c.isMovingSelected||c.isResizingSelected)&&(c.isMovingSelected=!1,c.isResizingSelected=!1,c.hoveredHandle=null,c.historyPushedInGesture=!1),c.isMarqueeSelecting){const t=Math.min(c.marqueeStartCX,c.marqueeEndCX),n=Math.min(c.marqueeStartCY,c.marqueeEndCY),s=Math.max(c.marqueeStartCX,c.marqueeEndCX),i=Math.max(c.marqueeStartCY,c.marqueeEndCY),r=s-t,o=i-n,d=r<3&&o<3,a=K();if(!c.marqueeAdditive&&!d&&c.selectedAssetIndices.clear(),d)c.marqueeAdditive||c.selectedAssetIndices.clear();else for(let h=0;h<M.length;h+=1){const f=U(a,M[h]);if(!f||f.w<=0||f.h<=0)continue;const u=Math.max(t,f.x),y=Math.max(n,f.y),l=Math.min(s,f.x+f.w),w=Math.min(i,f.y+f.h);u<l&&y<w&&c.selectedAssetIndices.add(h)}c.isMarqueeSelecting=!1,b()}})}class Et{constructor(t){He(this,"element");this.element=t,bt(t)}resize(){De()}draw(t){fe(t)}scheduleRedraw(){b()}setLowQualityMode(t){Mt(t)}setVisibility(t){xt(t)}setGridEnabled(t){Ne(t)}getGridEnabled(){return Ae()}getDimensions(){return Le()}static computeGeometry(t,n,s,i){return Fe(t,n,s,i)}}function Le(){if(Y)return{width:Y.width,height:Y.height};const e=L.getBoundingClientRect();return{width:Math.max(1,Math.round(e.width)),height:Math.max(1,Math.round(e.height))}}function It(e){return e<600?4:e<1024?8:12}function At(e,t,n){const s=Math.max(1,Math.floor(t/130));return Math.max(1,Math.min(Math.round(n),s))}function St(){const e=Math.min(2,window.devicePixelRatio||1);return le||c.isMovingSelected||c.isResizingSelected?1:e}function Fe(e,t,n,s){const i=e/n,r=t/s,o=[],d=[];for(let a=1;a<n;a+=1)o.push(a*i);for(let a=1;a<s;a+=1)d.push(a*r);return{width:e,height:t,cols:n,rows:s,colWidth:i,rowHeight:r,verticals:o,horizontals:d}}function Ct(e){const{width:t,height:n,cols:s,rows:i,verticals:r,horizontals:o}=e,d=`${Math.round(t)}x${Math.round(n)}-${s}x${i}`;if(d===qe&&N)return;qe=d,N||(N=document.createElement("canvas"),Pe=N.getContext("2d",{alpha:!0})),N.width=Math.max(1,Math.round(t)),N.height=Math.max(1,Math.round(n));const a=Pe;a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,t,n),a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="low",a.strokeStyle=nt,a.lineWidth=1,a.beginPath();for(let h=0;h<r.length;h+=1){const f=r[h];a.moveTo(f,0),a.lineTo(f,n)}for(let h=0;h<o.length;h+=1){const f=o[h];a.moveTo(0,f),a.lineTo(t,f)}if(a.stroke(),window.createImageBitmap){if($&&$.close){try{$.close()}catch{}$=null}createImageBitmap(N).then(h=>{$=h,b()}).catch(()=>{$=null})}}function De(){const e=St(),t=L.getBoundingClientRect(),n=Math.max(1,Math.round(t.width)),s=Math.max(1,Math.round(t.height));L.width=Math.max(1,Math.floor(n*e)),L.height=Math.max(1,Math.floor(s*e));const i=L.getContext("2d");i.setTransform(e,0,0,e,0,0),i.imageSmoothingEnabled=!le,i.imageSmoothingQuality=le?"low":"high";const r=It(n),o=Math.max(1,Math.floor(s/130)),d=Math.min(r,o),a=At(n,s,d);Y=Fe(n,s,d,a),Ct(Y),ue=!0,fe(K())}function b(){ve||(ve=!0,requestAnimationFrame(()=>{ve=!1,fe(K())}))}function K(){return L.getContext("2d")}function Lt(e){const t=L.getBoundingClientRect();return{x:Math.round(e.clientX-t.left),y:Math.round(e.clientY-t.top)}}function Te(e){if(!e)return null;const t=String(e).match(/(\d+(?:\.\d+)?)px/);return t?parseFloat(t[1]):null}function Tt(e,t){const n=String(e||"bold 48px Arial");return/(\d+(?:\.\d+)?)px/.test(n)?n.replace(/(\d+(?:\.\d+)?)px/,`${Math.max(1,Math.round(t))}px`):`${Math.max(1,Math.round(t))}px ${n}`}function Bt(e,t,n){const{width:s}=Le(),i=Math.max(120,Math.min(n||s-16,s-16)),r=String(t||"").split(/\s+/),o=Math.round((Te(e.font)||16)*1.2);let d="",a=0,h=0;const f=[];for(let u=0;u<r.length;u+=1){const y=d?d+" "+r[u]:r[u];e.measureText(y).width>i&&d?(f.push(d),a=Math.max(a,e.measureText(d).width),h+=o,d=r[u]):d=y}return d&&(f.push(d),a=Math.max(a,e.measureText(d).width),h+=o),{width:Math.round(a),height:Math.round(h),lineHeight:o,lines:f,limit:i}}function Se(e,t){if(!p||!t)return;const{width:n,height:s}=t;if(p.type==="image"){const i=p.element||p.bitmap;if(!i)return;const r=i.width||i.videoWidth||i.naturalWidth||0,o=i.height||i.videoHeight||i.naturalHeight||0;if(!r||!o)return;const d=Math.max(n/r,s/o),a=Math.round(r*d),h=Math.round(o*d),f=Math.round((n-a)/2),u=Math.round((s-h)/2);try{e.save(),e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="low",e.drawImage(i,f,u,a,h),e.restore()}catch{}}else if(p.type==="video"){const i=p.element;if(!i||!p.ready)return;const r=i.videoWidth,o=i.videoHeight;if(!r||!o)return;const d=Math.max(n/r,s/o),a=Math.round(r*d),h=Math.round(o*d),f=Math.round((n-a)/2),u=Math.round((s-h)/2);try{e.save(),e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high",e.drawImage(i,f,u,a,h);const y=Math.round(f+a/2),l=Math.round(u+h/2),w=!i.paused&&!i.ended;if(e.globalAlpha=.9,e.fillStyle="rgba(17,24,39,0.65)",e.beginPath(),e.arc(y,l,W+6,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.fillStyle="white",w){const g=Math.max(4,Math.floor(W*.35)),m=Math.max(10,Math.floor(W*.95)),x=Math.max(4,Math.floor(W*.3));e.fillRect(y-x-g,l-Math.floor(m/2),g,m),e.fillRect(y+x,l-Math.floor(m/2),g,m)}else{e.beginPath();const g=Math.max(10,Math.floor(W*.85));e.moveTo(y-Math.floor(g*.45),l-g),e.lineTo(y+Math.floor(g*.95),l),e.lineTo(y-Math.floor(g*.45),l+g),e.closePath(),e.fill()}e.restore()}catch{}}else p.type==="text"&&(e.save(),e.fillStyle=p.color||"#111827",e.font=p.font||"bold 48px Arial",$e(e,p.text||"",16,24,n-32),e.restore())}function kt(e,t){if(!p||!t){F=null;return}O||(O=document.createElement("canvas"),ze=O.getContext("2d")),O.width=Math.max(1,Math.round(t.width)),O.height=Math.max(1,Math.round(t.height));const n=ze;if(n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,O.width,O.height),Se(n,t),window.createImageBitmap&&p.type!=="video"){if(F&&F.close)try{F.close()}catch{}createImageBitmap(O).then(s=>{F=s,b()}).catch(()=>{F=null})}else F=null;ue=!1}function fe(e){if(!Y)return;const{width:t,height:n}=Y;e.clearRect(0,0,t,n),e.save(),e.fillStyle=it,e.fillRect(0,0,t,n),e.restore(),p&&(p.type==="video"?Se(e,Y):(ue&&kt(e,Y),F?e.drawImage(F,0,0,t,n):O?e.drawImage(O,0,0,t,n):Se(e,Y))),Ce&&($?e.drawImage($,0,0,t,n):N&&e.drawImage(N,0,0,t,n)),Rt(e),Ht(e),Wt(e),e.strokeStyle=st,e.lineWidth=1.25,e.strokeRect(0,0,t,n)}function Rt(e){for(let t=0;t<M.length;t+=1){const n=M[t];if(n.type==="image"&&n.loaded)try{n.bitmap?e.drawImage(n.bitmap,n.x,n.y,n.width,n.height):n.element&&e.drawImage(n.element,n.x,n.y,n.width,n.height)}catch{}else if(n.type==="video"&&n.element&&n.ready){try{vt(n.element);const o=wt(n.element,n.width,n.height);o.ctx.imageSmoothingEnabled=!0,o.ctx.imageSmoothingQuality="low",o.ctx.clearRect(0,0,o.canvas.width,o.canvas.height),o.ctx.drawImage(n.element,0,0,o.canvas.width,o.canvas.height),e.drawImage(o.canvas,n.x,n.y,n.width,n.height)}catch{}const s=Math.round(n.x+n.width/2),i=Math.round(n.y+n.height/2),r=!n.element.paused&&!n.element.ended;if(e.save(),e.globalAlpha=.9,e.fillStyle="rgba(17,24,39,0.65)",e.beginPath(),e.arc(s,i,W+6,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.fillStyle="white",r){const o=Math.max(4,Math.floor(W*.35)),d=Math.max(4,Math.floor(W*.25)),a=Math.floor(W*1.2);e.fillRect(s-d-o,i-Math.floor(a/2),o,a),e.fillRect(s+d,i-Math.floor(a/2),o,a)}else{const o=Math.floor(W*1.2);e.beginPath(),e.moveTo(s-Math.floor(o*.45),i-Math.floor(o*.65)),e.lineTo(s-Math.floor(o*.45),i+Math.floor(o*.65)),e.lineTo(s+Math.floor(o*.85),i),e.closePath(),e.fill()}e.restore()}else if(n.type==="text"){e.save(),e.fillStyle=n.color||"#ffffff",e.font=n.font||"16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const s=n.textAlign||"left";e.textAlign=s,e.textBaseline="top",$e(e,n.text||"",n.x,n.y,n.maxWidth,s),e.restore()}}Ye&&pt()&&requestAnimationFrame(()=>fe(K()))}function Wt(e){if(!c.isMarqueeSelecting)return;const t=c.marqueeStartCX,n=c.marqueeStartCY,s=c.marqueeEndCX,i=c.marqueeEndCY,r=Math.min(t,s),o=Math.min(n,i),d=Math.abs(s-t),a=Math.abs(i-n);e.save(),e.fillStyle="rgba(99, 102, 241, 0.15)",e.strokeStyle="rgba(99, 102, 241, 0.9)",e.lineWidth=1.5,e.setLineDash([6,4]),e.fillRect(r,o,d,a),e.strokeRect(r,o,d,a),e.restore()}function $e(e,t,n,s,i,r="left"){const{width:o}=Le(),d=Math.max(120,Math.min(i||o-16,o-16)),a=String(t||"").split(/\s+/),h=Math.round((Te(e.font)||16)*1.2);let f="",u=s;const y=(l,w)=>{e.fillText(l,n,w)};for(let l=0;l<a.length;l+=1){const w=f?f+" "+a[l]:a[l];e.measureText(w).width>d&&f?(y(f,u),f=a[l],u+=h):f=w}f&&y(f,u)}function U(e,t){if(t.type==="image"||t.type==="video")return{x:t.x,y:t.y,w:t.width,h:t.height};if(t.type==="text"){const n=e.font;t.font&&(e.font=t.font);const s=Bt(e,t.text||"",t.maxWidth);e.font=n;const i=t.textAlign||"left",r=s.width,o=s.height;return i==="center"?{x:Math.round(t.x-r/2),y:t.y,w:r,h:o}:{x:t.x,y:t.y,w:r,h:o}}return{x:0,y:0,w:0,h:0}}function Ht(e){if(!c.isMarqueeSelecting&&c.hoveredAssetIndex>=0&&!c.selectedAssetIndices.has(c.hoveredAssetIndex)){const t=U(e,M[c.hoveredAssetIndex]);e.save(),e.setLineDash([4,10]),e.lineWidth=1.75,e.strokeStyle="rgba(67,56,202,0.95)",e.strokeRect(t.x,t.y,t.w,t.h),e.restore()}if(c.selectedAssetIndices.size>0){if(e.save(),e.setLineDash([]),e.lineWidth=2,e.strokeStyle="rgba(79,70,229,0.95)",c.selectedAssetIndices.size===1){const t=Array.from(c.selectedAssetIndices)[0],n=M[t],s=U(e,n);e.strokeRect(s.x,s.y,s.w,s.h);const i=ae(s);e.fillStyle="rgba(79,70,229,0.95)";const r=Math.floor(_e/2),o=(a,h)=>{e.beginPath(),e.arc(a,h,r,0,Math.PI*2),e.save(),e.lineWidth=2,e.strokeStyle="white",e.stroke(),e.restore(),e.fill()},d=(a,h,f,u,y)=>{const l=Math.min(y,Math.min(f,u)/2);e.beginPath(),e.moveTo(a+l,h),e.arcTo(a+f,h,a+f,h+u,l),e.arcTo(a+f,h+u,a,h+u,l),e.arcTo(a,h+u,a,h,l),e.arcTo(a,h,a+f,h,l),e.closePath(),e.fill()};if(o(i.tl.x+r,i.tl.y+r),o(i.tr.x+r,i.tr.y+r),o(i.bl.x+r,i.bl.y+r),o(i.br.x+r,i.br.y+r),n.type==="text"){const a=Math.floor(Math.min(i.ml.w,i.ml.h)/2);e.save(),e.lineWidth=2,e.strokeStyle="white",d(i.ml.x,i.ml.y,i.ml.w,i.ml.h,a),e.stroke(),e.restore(),e.save(),e.lineWidth=2,e.strokeStyle="white",d(i.mr.x,i.mr.y,i.mr.w,i.mr.h,a),e.stroke(),e.restore()}}else{let t=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;for(const r of c.selectedAssetIndices){const o=U(e,M[r]);!o||o.w<=0||o.h<=0||(t=Math.min(t,o.x),n=Math.min(n,o.y),s=Math.max(s,o.x+o.w),i=Math.max(i,o.y+o.h))}isFinite(t)&&isFinite(n)&&isFinite(s)&&isFinite(i)&&e.strokeRect(t,n,s-t,i-n)}e.restore()}}function ae(e){const t=_e,n=Math.floor(t/2),s=e.y+Math.round(e.h/2);return{tl:{x:e.x-n,y:e.y-n,w:t,h:t},tr:{x:e.x+e.w-n,y:e.y-n,w:t,h:t},bl:{x:e.x-n,y:e.y+e.h-n,w:t,h:t},br:{x:e.x+e.w-n,y:e.y+e.h-n,w:t,h:t},ml:{x:e.x-n,y:s-t,w:t,h:t*2},mr:{x:e.x+e.w-n,y:s-t,w:t,h:t*2}}}function Pt(e){switch(e){case"tl":case"br":return"nwse-resize";case"tr":case"bl":return"nesw-resize";case"ml":case"mr":return"ew-resize";default:return"default"}}function Me(e,t){if(!t)return;const n=t.querySelector('[data-selected="true"]')||t.querySelector(".btn.btn-primary"),s=n?n.getAttribute("value"):"landscape",r=e.parentElement.getBoundingClientRect(),o=document.getElementById("top-controls"),d=o?o.getBoundingClientRect():{bottom:48},a=32,h=Math.max(0,window.innerHeight-(d.bottom||48)-a),f=window.innerHeight*.8,u=Math.min(f,h||f),y=r.width*.98;let l=y,w=u;if(s==="square"){const m=Math.min(y,u);l=m,w=m}else if(s==="portrait"){const v=u*.46153846153846156,E=y*(19.5/9);v<=y?(l=v,w=u):(l=y,w=E)}else{const m=y*.5625,x=u*(16/9);m<=u?(l=y,w=m):(l=x,w=u)}e.style.width=`${Math.floor(l)}px`,e.style.height=`${Math.floor(w)}px`;const g=document.getElementById("top-controls");g&&(g.style.width=`${Math.floor(l)}px`),e.style.marginTop=`${a}px`,requestAnimationFrame(()=>{De(),re(e)})}function re(e){const t=document.getElementById("top-controls"),n=document.getElementById("grid-toggle-floating");if(!t)return;const s=e.getBoundingClientRect();t.style.left=`${s.left+s.width/2}px`,t.style.transform="translateX(-50%)",t.style.width=`${Math.floor(s.width)}px`,n&&(n.style.left=`${s.left+12}px`,n.style.top=`${s.bottom+12}px`,n.style.width="auto")}function qt(e,t){t&&(t.addEventListener("click",n=>{const i=(n.composedPath&&n.composedPath()||[]).find(r=>r&&r.tagName&&r.tagName.toLowerCase&&r.tagName.toLowerCase()==="button");i&&i.closest("#canvas-size-group")&&(t.querySelectorAll("button").forEach(r=>{r.classList.remove("btn-primary"),r.dataset.selected="false",r.setAttribute("aria-pressed","false")}),i.classList.add("btn-primary"),i.dataset.selected="true",i.setAttribute("aria-pressed","true"),Me(e,t))}),Me(e,t),re(e),window.addEventListener("resize",()=>{Me(e,t),re(e)}),window.addEventListener("scroll",()=>{re(e)},{passive:!0}))}function zt(e){if(!e)return;const t=Ae();e.classList.toggle("active",t),e.setAttribute("aria-pressed",String(t)),e.addEventListener("click",()=>{const n=!Ae();Ne(n),e.classList.toggle("active",n),e.setAttribute("aria-pressed",String(n))})}function Ve(){const e=M.some(n=>n.type==="video"&&n.element&&!n.element.paused&&!n.element.ended),t=p&&p.type==="video"&&p.element&&!p.element.paused&&!p.element.ended;return e||t}function Ot(){const e=M.some(n=>n.type==="video"),t=!!(p&&p.type==="video");return e||t}function Ut(){let e=!1;for(const t of M)if(t.type==="video"&&t.element){try{t.element.currentTime=0}catch{}try{t.element.play().catch(()=>{}),e=!0}catch{}}if(p&&p.type==="video"&&p.element){try{p.element.currentTime=0}catch{}try{p.element.play().catch(()=>{}),e=!0}catch{}}e&&b()}function Xt(){let e=!1;for(const t of M)if(t.type==="video"&&t.element)try{t.element.pause(),e=!0}catch{}if(p&&p.type==="video"&&p.element)try{p.element.pause(),e=!0}catch{}e&&b()}function se(e){if(!e)return;const t=Ot(),n=t&&Ve(),s='<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>',i='<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>';e.innerHTML=n?s:i,e.setAttribute("aria-label",n?"Pause all videos":"Play all videos"),e.classList.toggle("active",n),e.setAttribute("aria-pressed",String(n)),e.disabled=!t,e.setAttribute("aria-disabled",String(!t))}function Yt(e){e&&(e.addEventListener("click",()=>{Ve()?Xt():Ut(),se(e)}),document.addEventListener("assets:changed",()=>se(e)),["play","pause","ended","ratechange"].forEach(t=>{document.addEventListener(t,()=>se(e),!0)}),se(e))}let G=null;function _t(){try{return new URL(window.location.href).searchParams.get("debug")==="1"?!0:localStorage.getItem("debug")==="1"}catch{return!1}}function Nt(){return _t()?G||(G=document.createElement("div"),G.setAttribute("id","debug-overlay"),Object.assign(G.style,{position:"fixed",right:"8px",bottom:"8px",maxWidth:"38vw",background:"rgba(17,24,39,0.85)",color:"#e5e7eb",border:"1px solid rgba(255,255,255,0.18)",borderRadius:"8px",padding:"8px",font:"12px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",zIndex:"1000",pointerEvents:"none",whiteSpace:"pre-wrap",overflow:"auto",maxHeight:"40vh"}),document.body.appendChild(G),G):null}function C(e,t){try{console.log("[DEBUG]",e,t??"")}catch{}const n=Nt();if(!n)return;const s=new Date().toLocaleTimeString(),i=document.createElement("div");i.textContent=`${s} ${e}${t!==void 0?" "+Ft(t):""}`,n.appendChild(i),n.scrollTop=n.scrollHeight}function Ft(e){try{return typeof e=="string"?e:JSON.stringify(e)}catch{return String(e)}}const xe={};function Dt(e){const t=document.getElementById("open-generate-text"),n=document.getElementById("add-text-overlay");if(!t||!n)return;const s=document.getElementById("generate-text-input"),i=document.getElementById("generate-preview"),r=document.getElementById("add-text-cancel"),o=document.getElementById("generate-text"),d=document.getElementById("add-text-confirm"),a=document.getElementById("prompt-suggestions"),h=n==null?void 0:n.querySelector(".modal"),f=()=>{n.classList.add("show"),n.setAttribute("aria-hidden","false"),d&&(d.disabled=!0),l()},u=()=>{n.classList.remove("show"),n.setAttribute("aria-hidden","true")},y=()=>{if(!o||!s)return;const g=!!(s.value&&s.value.trim().length>0);o.disabled=!g};if(t.addEventListener("click",()=>{f(),y(),s==null||s.focus()}),r==null||r.addEventListener("click",()=>u()),n.addEventListener("click",g=>{g.target===n&&u()}),document.addEventListener("keydown",g=>{n.classList.contains("show")&&g.key==="Escape"&&u()}),i&&d&&i.parentElement){try{i.insertAdjacentElement("afterend",d)}catch{}try{d.style.marginTop="10px",d.style.float="right"}catch{}}if(a&&(a.style.display="none"),r&&(r.style.display="none"),h){const g=document.createElement("button");g.className="close-btn",g.type="button",g.setAttribute("aria-label","Close"),g.textContent="×",g.addEventListener("click",()=>u());try{h.insertAdjacentElement("afterbegin",g)}catch{}}s==null||s.addEventListener("input",y),a==null||a.addEventListener("click",g=>{const m=g.target.closest("[data-topic]");!m||!s||(s.value=m.getAttribute("data-topic")||"",y())});const l=()=>{i&&(i.style.width="100%",i.style.minHeight="120px",i.style.padding="10px 12px",i.style.borderRadius="8px",i.style.border="1px solid rgba(255,255,255,0.18)",i.style.background="rgba(255,255,255,0.06)",i.style.color="var(--text)",i.style.font=de)};async function w(g){var I,A,T,B,H;const m=(xe==null?void 0:xe.VITE_OPENAI_API_KEY)||localStorage.getItem("OPENAI_API_KEY")||"",x="You generate concise marketing copy. Reply with under 12 words.",v=`Generate a short line (under 12 words) about: ${g}`,E=P=>{const z=['"',"'","“","‘"],q=['"',"'","”","’"];let S=(P||"").trim();if(S.length>=2){const _=S[0],ge=S[S.length-1];z.includes(_)&&q.includes(ge)&&(S=S.slice(1,-1).trim())}return S};if(!m)return(g?`${g} – limited-time offer. Join us today!`:"Create something unforgettable. Join us today!").split(/\s+/).slice(0,12).join(" ");try{const z=await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"system",content:x},{role:"user",content:v}],temperature:.7,max_tokens:40})})).json(),q=((H=(B=(T=(A=(I=z==null?void 0:z.choices)==null?void 0:I[0])==null?void 0:A.message)==null?void 0:T.content)==null?void 0:B.trim)==null?void 0:H.call(B))||"";return E(q).split(/\s+/).slice(0,12).join(" ")}catch{const P=g?`${g} – limited-time offer. Join us today!`:"Create something unforgettable. Join us today!";return E(P).split(/\s+/).slice(0,12).join(" ")}}o==null||o.addEventListener("click",async()=>{if(!s||!i)return;const g=(s.value||"").trim();i.value="Generating…",d&&(d.disabled=!0);const m=await w(g);i.value=m,d&&(d.disabled=!m.trim()),l()}),i==null||i.addEventListener("input",()=>{d&&(d.disabled=!i.value.trim())}),d==null||d.addEventListener("click",()=>{if(!i)return;const g=(i.value||"").trim();if(!g)return;const m=e.getBoundingClientRect(),x=Math.round(m.width/2),v=Math.max(240,Math.floor(m.width*.7)),E=x,I=Math.max(64,Math.round(m.height*.22));R({type:"text",x:E,y:I,text:g,color:Ie,font:de,maxWidth:v,textAlign:"center"}),b(),u(),C("generate overlay: added text")})}function $t(){const e=document.getElementById("context-menu"),t=document.getElementById("ctx-delete"),n=document.getElementById("ctx-duplicate"),s=document.getElementById("ctx-cut"),i=document.getElementById("ctx-paste"),r=document.getElementById("ctx-bring-front"),o=document.getElementById("ctx-bring-forward"),d=document.getElementById("ctx-send-backward"),a=document.getElementById("ctx-send-back"),h=document.getElementById("ctx-set-bg"),f=document.getElementById("ctx-bgd-detach"),u=document.getElementById("ctx-bgd-delete");if(!e)return;const y=()=>{e.setAttribute("aria-hidden","true"),e.classList.remove("show")};function l(m,x){m&&(m.classList.toggle("disabled",!x),m.setAttribute("aria-disabled",String(!x)))}function w(){const m=c.selectedAssetIndices.size>0,v=!!p&&!m&&c.hoveredAssetIndex===-1,E=!m&&c.hoveredAssetIndex===-1,I=[h,n,t,r,o,a,d,s],A=[f,u];for(const S of I)S&&(S.style.display=v?"none":"");for(const S of A)S&&(S.style.display=v?"":"none");if(E){for(const S of I)S&&(S.style.display="none");for(const S of A)S&&(S.style.display="none")}let T=!1;if(m&&c.selectedAssetIndices.size===1){const S=Array.from(c.selectedAssetIndices)[0],_=M[S];T=!!_&&_.type!=="text"}h&&(h.style.display=v?"none":T?"":"none"),l(h,T),l(n,m),l(s,m);const B=Array.isArray(window.__clipboard)&&window.__clipboard.length>0;if(i&&(i.style.display=""),l(i,B),l(t,m),l(r,m),l(o,m),l(a,m),l(d,m),!m)return;const H=Array.from(c.selectedAssetIndices).sort((S,_)=>S-_),P=H[0]??0,z=H[H.length-1]??0,q=M.length?M.length-1:void 0;l(o,q!==void 0?z<q:!0),l(r,q!==void 0?z<q:!0),l(d,P>0),l(a,P>0)}const g=(m,x)=>{w();const v=window.innerWidth,E=window.innerHeight,I=e.getBoundingClientRect(),A=Math.max(8,Math.min(v-I.width-8,m)),T=Math.max(8,Math.min(E-I.height-8,x));e.style.left=`${A}px`,e.style.top=`${T}px`,e.style.bottom="auto",e.style.transform="none",e.classList.add("show"),e.setAttribute("aria-hidden","false")};document.addEventListener("contextmenu",m=>{m.preventDefault(),g(m.clientX,m.clientY)}),document.addEventListener("click",m=>{e.contains(m.target)||y()}),document.addEventListener("keydown",m=>{m.key==="Escape"&&y()}),t==null||t.addEventListener("click",()=>{if(y(),c.selectedAssetIndices.size===0)return;k(),ce()&&b()}),n==null||n.addEventListener("click",()=>{y(),c.selectedAssetIndices.size!==0&&(k(),ot(),b())}),s==null||s.addEventListener("click",()=>{if(y(),c.selectedAssetIndices.size===0)return;k();const m=Array.from(c.selectedAssetIndices).sort((v,E)=>v-E);window.__clipboard=m.map(v=>M[v]&&{...M[v]}),ce()&&b()}),i==null||i.addEventListener("click",()=>{y();const m=window.__clipboard;if(!Array.isArray(m)||m.length===0)return;const x=M.length;for(const v of m){if(!v)continue;const E={...v};if(typeof E.x=="number"&&(E.x+=12),typeof E.y=="number"&&(E.y+=12),E.type==="image"){if(E.sourceUrl){const I=new Image;I.crossOrigin="anonymous",I.decoding="async",I.src=E.sourceUrl,E.element=I,E.loaded=!0,E.bitmap=null}}else if(E.type==="video"){const I=document.createElement("video");I.crossOrigin="anonymous",I.playsInline=!0,I.muted=!0,I.loop=!0,I.preload="metadata",E.sourceUrl&&(I.src=E.sourceUrl),E.element=I,E.ready=!1,I.addEventListener("loadeddata",()=>{E.ready=!0;try{I.pause()}catch{}})}M.push(E)}c.selectedAssetIndices.clear();for(let v=x;v<M.length;v+=1)c.selectedAssetIndices.add(v);b()}),r&&r.classList.add("group-start"),r==null||r.addEventListener("click",()=>{y(),c.selectedAssetIndices.size!==0&&(k(),at(),b())}),o==null||o.addEventListener("click",()=>{y(),c.selectedAssetIndices.size!==0&&(k(),rt(),b())}),d==null||d.addEventListener("click",()=>{y(),c.selectedAssetIndices.size!==0&&(k(),dt(),b())}),a==null||a.addEventListener("click",()=>{y(),c.selectedAssetIndices.size!==0&&(k(),ct(),b())}),u==null||u.addEventListener("click",()=>{y(),p&&(k(),j(null),b())}),f==null||f.addEventListener("click",()=>{var I;if(y(),!p)return;k();const m=document.getElementById("main-canvas"),x=(I=m==null?void 0:m.getBoundingClientRect)==null?void 0:I.call(m),v=x?Math.round(x.width/2):400,E=x?Math.round(x.height/2):300;if(p.type==="image"){const A=p.element||p.bitmap||null,T=(A==null?void 0:A.naturalWidth)||(A==null?void 0:A.width)||400,B=(A==null?void 0:A.naturalHeight)||(A==null?void 0:A.height)||300,H={type:"image",x:v-Math.round(T/2),y:E-Math.round(B/2),width:T,height:B,element:p.element||null,bitmap:p.bitmap||null,loaded:!0,sourceUrl:""};M.push(H)}else if(p.type==="video"){const A=p.element;if(!A){j(null),b();return}const T=A.videoWidth||480,B=A.videoHeight||270,H={type:"video",x:v-Math.round(T/2),y:E-Math.round(B/2),width:T,height:B,element:A,ready:!0,sourceUrl:A.currentSrc||""};M.push(H)}else if(p.type==="text"){const A={type:"text",x:v-120,y:E,text:p.text||"",color:p.color,font:p.font,maxWidth:x?Math.floor(x.width*.6):480};M.push(A)}j(null),b()}),h==null||h.addEventListener("click",()=>{y(),c.selectedAssetIndices.size!==0&&(k(),lt()&&b())})}const oe=new Map,V=new Map,Vt=64;let be=0;const Gt=200*1024*1024;let Ee=0;const Xe=[],Kt=6;function jt(e){const t=()=>{Ee<Kt?(Ee+=1,e().finally(()=>{Ee-=1;const n=Xe.shift();n&&n()})):Xe.push(t)};t()}function Qt(e,t){V.delete(e),V.set(e,t),be+=Math.max(1,(t.width||1)*(t.height||1));const n=()=>{var r,o;const s=V.keys().next().value,i=V.get(s);if(V.delete(s),i){be-=Math.max(1,(i.width||1)*(i.height||1));try{i.bitmap&&((o=(r=i.bitmap).close)==null||o.call(r))}catch{}}};for(;V.size>Vt||be>Gt;)n()}async function Jt(e,t){const n=new AbortController,i=await(await fetch(e,{mode:"cors",credentials:"omit",cache:"no-cache",signal:n.signal})).blob();try{const r=await(t&&window.createImageBitmap?createImageBitmap(i,{resizeWidth:t.resizeWidth,resizeHeight:t.resizeHeight,resizeQuality:"high"}):createImageBitmap(i));return{bitmap:r,element:null,width:r.width||0,height:r.height||0}}catch{const r=new Image;r.crossOrigin="anonymous",r.decoding="async";const o=await new Promise((d,a)=>{r.onload=()=>d(r),r.onerror=a;const h=URL.createObjectURL(i);r.src=h,r.onload=()=>{try{URL.revokeObjectURL(h)}catch{}}});return{bitmap:null,element:o,width:o.naturalWidth||o.width||0,height:o.naturalHeight||o.height||0}}}function Zt(e,t){const n=t&&(t.resizeWidth||t.resizeHeight)?`@${t.resizeWidth||""}x${t.resizeHeight||""}`:"",s=`${e}${n}`;if(V.has(s))return Promise.resolve(V.get(s));if(oe.has(s))return oe.get(s);let i,r;const o=new Promise((d,a)=>{i=d,r=a});return oe.set(s,o),jt(async()=>{try{const d=await Jt(e,t);Qt(s,d),i(d)}catch(d){oe.delete(s),r(d)}}),o}function X(e,t,n,s=.35){const i=n.getBoundingClientRect(),r=Math.max(1,Math.round(Math.min(i.width,i.height)*s)),o=Math.max(e||1,t||1),d=Math.min(1,r/o);return{width:Math.max(1,Math.round((e||1)*d)),height:Math.max(1,Math.round((t||1)*d))}}async function te(e){var t,n;try{const s=document.getElementById("main-canvas"),i=s?X(1920,1080,s,.35):{width:0,height:0},r=await Zt(e,i.width&&i.height?{resizeWidth:i.width*2,resizeHeight:i.height*2}:void 0),o=r.width||((t=r.element)==null?void 0:t.naturalWidth)||0,d=r.height||((n=r.element)==null?void 0:n.naturalHeight)||0,a=s?X(o,d,s,.35):{width:o,height:d},h=a.width,f=a.height;let u=null,y=null;r.bitmap?y=r.bitmap:r.element&&(u=new Image,u.crossOrigin="anonymous",u.decoding="async",u.src=r.element.currentSrc||r.element.src||e);let l=0,w=0;if(s){const g=s.getBoundingClientRect();l=Math.round((g.width-h)/2),w=Math.round((g.height-f)/2)}return{type:"image",x:l,y:w,width:h,height:f,element:u,bitmap:y,loaded:!0,sourceUrl:e,naturalWidth:o,naturalHeight:d}}catch{const s=new Image;s.crossOrigin="anonymous",s.decoding="async";const i=await new Promise((f,u)=>{s.onload=()=>f(s),s.onerror=u,s.src=e}),r=i.naturalWidth||i.width||0,o=i.naturalHeight||i.height||0,d=Math.min(1,tt/Math.max(r,o)),a=Math.round(r*d),h=Math.round(o*d);return{type:"image",x:0,y:0,width:a,height:h,element:i,loaded:!0,sourceUrl:e,naturalWidth:r,naturalHeight:o}}}function ne(e){const t=document.createElement("video");t.crossOrigin="anonymous",t.playsInline=!0,t.muted=!0,t.loop=!0,t.preload="auto";const n={type:"video",x:0,y:0,width:480,height:270,element:t,ready:!1,sourceUrl:e},s=()=>{const i=t.videoWidth||0,r=t.videoHeight||0;if(i>0&&r>0){const d=i/r;n.width=Math.round(480),n.height=Math.round(480/d)}};return t.addEventListener("loadedmetadata",()=>{s();try{t.currentTime=0}catch{}try{t.requestVideoFrameCallback&&t.requestVideoFrameCallback(()=>{})}catch{}}),t.addEventListener("seeked",()=>{if(!n.ready){n.ready=!0;try{t.pause(),b()}catch{}}}),t.addEventListener("loadeddata",()=>{n.ready=!0;try{t.pause(),b()}catch{}}),t.src=e,n}function en(e,t){var n;e&&((n=e.querySelectorAll("[data-asset-type]"))==null||n.forEach(s=>{const i=s.getAttribute("data-asset-type"),r=o=>{o.setAttribute("draggable","true"),o.addEventListener("dragstart",d=>{var a,h,f,u,y,l;try{d.dataTransfer.effectAllowed="copy"}catch{}if(C("dragstart from sidebar",{type:i}),document.body.classList.add("is-dragging-asset"),t.classList.add("drag-target"),i==="image"){const w=s.currentSrc||s.getAttribute("src")||"";(a=d.dataTransfer)==null||a.setData("text/uri-list",w?w+`
`:""),(h=d.dataTransfer)==null||h.setData("text/plain",w)}else if(i==="video"){const w=s.getAttribute("data-src")||((f=s.querySelector("video"))==null?void 0:f.src)||"";w&&((u=d.dataTransfer)==null||u.setData("text/uri-list",w+`
`),(y=d.dataTransfer)==null||y.setData("text/plain",w))}else i==="text"&&((l=d.dataTransfer)==null||l.setData("text/plain",(s.textContent||"").trim()))}),o.addEventListener("dragend",()=>{C("dragend"),document.body.classList.remove("is-dragging-asset"),t.classList.remove("drag-target")})};if(r(s),i==="video"){const o=s.querySelector("video");o&&r(o)}}))}function tn(e){e.addEventListener("dragover",t=>{t.preventDefault();try{t.dataTransfer.dropEffect="copy"}catch{}}),e.addEventListener("dragenter",()=>{e.classList.add("drag-target")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-target")}),e.addEventListener("drop",async t=>{var a,h,f;t.preventDefault(),C("drop on canvas");const n=e.getBoundingClientRect(),s=Math.round(t.clientX-n.left),i=Math.round(t.clientY-n.top),o=(((a=t.dataTransfer)==null?void 0:a.getData("text/uri-list"))||"").split(/\r?\n/).filter(Boolean)[0]||"",d=(((h=t.dataTransfer)==null?void 0:h.getData("text/plain"))||"").trim();try{const u=Array.from(((f=t.dataTransfer)==null?void 0:f.files)||[]);for(const l of u){const w=URL.createObjectURL(l);if(l.type.startsWith("video/")){const g=ne(w),m=()=>{const x=g.element.videoWidth||g.width,v=g.element.videoHeight||g.height,E=X(x,v,e,.35);g.width=E.width,g.height=E.height,g.x=s-Math.floor(g.width/2),g.y=i-Math.floor(g.height/2),b()};g.element.addEventListener("loadedmetadata",m,{once:!0}),R(g),b(),C("added dropped video (file)");return}else if(l.type.startsWith("image/")){const g=await te(w),m=X(g.naturalWidth||g.width,g.naturalHeight||g.height,e,.35);g.width=m.width,g.height=m.height,g.x=s-Math.floor(g.width/2),g.y=i-Math.floor(g.height/2),R(g),b(),C("added dropped image (file)");return}}const y=l=>!!l&&/^(https?:|blob:|data:)/i.test(l);if(o&&/\.(mp4|webm|ogg)(\?.*)?$/i.test(o)){const l=ne(o),w=()=>{const g=l.element.videoWidth||l.width,m=l.element.videoHeight||l.height,x=X(g,m,e,.35);l.width=x.width,l.height=x.height,l.x=s-Math.floor(l.width/2),l.y=i-Math.floor(l.height/2),b()};l.element.addEventListener("loadedmetadata",w,{once:!0}),R(l),b(),C("added dropped video");return}if(o)try{const l=await te(o),w=X(l.naturalWidth||l.width,l.naturalHeight||l.height,e,.35);l.width=w.width,l.height=w.height,l.x=s-Math.floor(l.width/2),l.y=i-Math.floor(l.height/2),R(l),b(),C("added dropped image");return}catch{}if(y(d)){if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(d)){const l=ne(d),w=()=>{const g=l.element.videoWidth||l.width,m=l.element.videoHeight||l.height,x=X(g,m,e,.35);l.width=x.width,l.height=x.height,l.x=s-Math.floor(l.width/2),l.y=i-Math.floor(l.height/2),b()};l.element.addEventListener("loadedmetadata",w,{once:!0}),R(l),b(),C("added dropped video (plain)");return}try{const l=await te(d),w=X(l.naturalWidth||l.width,l.naturalHeight||l.height,e,.35);l.width=w.width,l.height=w.height,l.x=s-Math.floor(l.width/2),l.y=i-Math.floor(l.height/2),R(l),b(),C("added dropped image (plain)");return}catch{}}if(d&&d.trim()){const l={type:"text",x:s,y:i,text:d.trim()};R(l),b(),C("added dropped text")}}catch{}})}function nn(e,t){var o;if(!e){C("bindAssetsPanel: no sidebar root");return}en(e,t),tn(t),(o=e.querySelectorAll("img,video"))==null||o.forEach(d=>{d.setAttribute("draggable","true")}),e.addEventListener("click",async d=>{var w;const a=d.target||null,h=a&&a.closest("[data-asset-type]");if(!h)return;const f=h.getAttribute("data-asset-type"),u=t.getBoundingClientRect(),y=Math.round(u.width/2),l=Math.round(u.height/2);try{if(f==="image"){const g=h.tagName==="IMG"?h:h.querySelector("img"),m=g&&(g.currentSrc||g.src)||"";if(!m)return;const x=await te(m),v=X(x.naturalWidth||x.width,x.naturalHeight||x.height,t,.35);x.width=v.width,x.height=v.height,x.x=y-Math.floor(x.width/2),x.y=l-Math.floor(x.height/2),R(x),b(),C("click-add image",{url:m})}else if(f==="video"){const g=h.getAttribute("data-src")||((w=h.querySelector("video"))==null?void 0:w.src)||"";if(!g)return;const m=ne(g),x=()=>{const v=m.element.videoWidth||m.width,E=m.element.videoHeight||m.height,I=X(v,E,t,.35);m.width=I.width,m.height=I.height,m.x=y-Math.floor(m.width/2),m.y=l-Math.floor(m.height/2),b()};m.element.addEventListener("loadedmetadata",x,{once:!0}),R(m),b(),C("click-add video",{url:g})}else if(f==="text"){const g=(h.textContent||"").trim();if(!g)return;const m=Math.max(240,Math.floor(u.width*.6)),x=Math.round(u.width/2),v=Math.max(48,Math.round(u.height*.2));R({type:"text",x,y:v,text:g,color:Ie,font:de,maxWidth:m,textAlign:"center"}),b(),C("click-add text")}}catch(g){C("click-add failed",String(g))}});const n=document.getElementById("upload-asset"),s=document.getElementById("upload-asset-input");n&&s&&(C("assetsPanel: upload bindings ready"),n.addEventListener("click",()=>s.click()),s.addEventListener("change",async()=>{const d=Array.from(s.files||[]);C("upload: files selected",d.map(a=>({name:a.name,type:a.type,size:a.size})));for(const a of d)try{const h=URL.createObjectURL(a);if(a.type.startsWith("image/")){const f=await te(h);f.x=24,f.y=24,R(f),C("added image asset",{w:f.width,h:f.height})}else if(a.type.startsWith("video/")){const f=ne(h);f.x=24,f.y=24,R(f),C("added video asset",{w:f.width,h:f.height})}}catch{}b(),s.value=""}));const i=document.getElementById("inline-add-text-input"),r=document.getElementById("inline-add-text-btn");if(i&&r){const d=()=>{r.disabled=!(i.value&&i.value.trim().length>0)};i.addEventListener("input",d),i.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),r.disabled||r.click())}),d(),r.addEventListener("click",()=>{const a=(i.value||"").trim();if(!a)return;const h=t.getBoundingClientRect(),f=Math.round(h.width/2);Math.round(h.height/2);const u=Math.max(240,Math.floor(h.width*.6)),y=f,l=Math.max(48,Math.round(h.height*.2));R({type:"text",x:y,y:l,text:a,color:Ie,font:de,maxWidth:u,textAlign:"center"}),C("added text asset",a),i.value="",d(),b()})}}const me=document.getElementById("main-canvas"),sn=document.getElementById("canvas-size-group"),on=document.getElementById("toggle-grid-btn"),an=document.getElementById("toggle-videos-btn"),rn=document.querySelector(".sidebar"),he=new Et(me);qt(me,sn);zt(on);Yt(an);nn(rn,me);Dt(me);$t();he.resize();document.addEventListener("visibilitychange",()=>he.setVisibility(document.visibilityState==="visible"));window.addEventListener("keydown",e=>{(/Mac|iPod|iPhone|iPad/.test(navigator.platform)?e.metaKey:e.ctrlKey)&&(e.key==="l"||e.key==="L")&&(he.setLowQualityMode(!0),he.resize(),e.preventDefault());const s=e.key;if(s==="Delete"||s==="Backspace"){const d=document.activeElement;!(!!d&&(d.tagName==="INPUT"||d.tagName==="TEXTAREA"||d.isContentEditable))&&c.selectedAssetIndices.size>0&&(e.preventDefault(),k(),ce()&&b())}if((/Mac|iPod|iPhone|iPad/.test(navigator.platform)?e.metaKey:e.ctrlKey)&&(e.key==="x"||e.key==="X")&&c.selectedAssetIndices.size>0){e.preventDefault();const d=Array.from(c.selectedAssetIndices).sort((h,f)=>h-f);window.__clipboard=d.map(h=>assets[h]?{...assets[h]}:null).filter(Boolean),k(),ce()&&b()}});
